@using INeed.Data
@using INeed.Helpers
@inject ApplicationDbContext _context

@{
    var currentVisitorId = AppConstants.GetVisitorId(ViewBag.VisitorId as string ?? Context.Request.Query["visitorId"].ToString());
    string GetButtonColor(string controller, string action, string? formId = null)
    {
        var currentController = ViewContext.RouteData.Values["Controller"]?.ToString();
        var currentAction = ViewContext.RouteData.Values["Action"]?.ToString();
        var queryKw = Context.Request.Query["kw"].ToString();

        bool isControllerMatch = string.Equals(currentController, controller, StringComparison.OrdinalIgnoreCase);
        bool isActionMatch = string.Equals(currentAction, action, StringComparison.OrdinalIgnoreCase);
        if (isControllerMatch && isActionMatch)
        {
            if (formId == null) return AppConstants.Colors.ActiveNav;
            if (!string.IsNullOrEmpty(queryKw) && string.Equals(queryKw, formId, StringComparison.OrdinalIgnoreCase))
            {
                return AppConstants.Colors.ActiveNav;
            }
        }
        return AppConstants.Colors.Accent;
    }
}

<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData[AppConstants.Keys.Title] - @AppConstants.Texts.CompanyName</title>

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/bootstrap_colors.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/INeed.styles.css" asp-append-version="true" />
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800&family=Raleway:wght@400;600&display=swap" rel="stylesheet">

    <style>
        .flag-hover {
            transition: transform 0.2s ease-in-out, opacity 0.2s;
            opacity: 0.85;
            cursor: pointer;
        }

            .flag-hover:hover {
                transform: scale(1.15);
                opacity: 1.0;
                filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
            }

        .navbar-toggler:focus {
            box-shadow: none;
            /* WCAG: Wymuszenie widoczności fokusu dla przycisku menu mobilnego */
            outline: 3px solid @AppConstants.Colors.FocusOutline;
        }

        .mobile-nav-link {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

            .mobile-nav-link:last-child {
                border-bottom: none;
            }

        /* WCAG: Skip link style */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: @AppConstants.Colors.ButtonAction;
            color: #000;
            padding: 8px;
            z-index: 9999;
            transition: top 0.1s;
            text-decoration: none;
            font-weight: bold;
        }

            .skip-link:focus {
                top: 0;
            }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">

    @* WCAG 2.4.1: Mechanizm pomijania bloków (Skip Link) *@
    <a href="#main-content" class="skip-link">Przejdź do treści głównej</a>

    @* --- PASEK MOBILNY --- *@
    <nav class="navbar navbar-dark d-lg-none w-100 shadow-sm border-bottom border-secondary border-opacity-25"
         style="background-color: @AppConstants.Colors.Primary; flex-shrink: 0; z-index: 1000;">
        <h1 class="visually-hidden">Nawigacja mobilna</h1>

        <div class="container-fluid">

            <a class="navbar-brand d-flex align-items-center gap-2"
               asp-controller="@AppConstants.Routing.HomeController"
               asp-action="@AppConstants.Routing.ActionIndex"
               asp-route-visitorId="@currentVisitorId">
                <img src="@Url.Content(AppConstants.Assets.LogoPath)" alt="Logo @AppConstants.Texts.CompanyName" style="height: 35px; width: auto;">
                <span class="fw-bold small text-uppercase" style="letter-spacing: 1px;">@AppConstants.Texts.CompanyName</span>
            </a>

            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#mobileNavbar"
                    aria-controls="mobileNavbar" aria-expanded="false" aria-label="Menu">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse mt-2" id="mobileNavbar" style="background-color: rgba(0,0,0,0.2); border-radius: 10px;">
                <ul class="navbar-nav p-2">
                    <li class="nav-item mobile-nav-link">
                        <a class="nav-link text-white py-2 px-3"
                           asp-controller="@AppConstants.Routing.HomeController"
                           asp-action="@AppConstants.Routing.ActionIndex"
                           asp-route-visitorId="@currentVisitorId">
                            <i class="bi bi-house-door-fill me-2 text-warning" aria-hidden="true"></i> @AppConstants.Texts.Layout.Questionnaires
                        </a>
                    </li>

                    @if (_context.Forms != null)
                    {
                        foreach (var form in _context.Forms.Where(f => f.IsActive).ToList())
                        {
                            <li class="nav-item mobile-nav-link">
                                <a class="nav-link text-white-50 py-2 px-3 ps-4 small"
                                   asp-controller="@AppConstants.Routing.QuestionnaireController"
                                   asp-action="@AppConstants.Routing.ActionFill"
                                   asp-route-kw="@form.Id"
                                   asp-route-visitorId="@currentVisitorId">
                                    <i class="bi bi-file-text me-2" aria-hidden="true"></i> @form.Title
                                </a>
                            </li>
                        }
                    }

                    <li class="nav-item mobile-nav-link">
                        <a class="nav-link text-white py-2 px-3"
                           asp-controller="@AppConstants.Routing.HomeController"
                           asp-action="@AppConstants.Routing.ActionContact"
                           asp-route-visitorId="@currentVisitorId">
                            <i class="bi bi-envelope-fill me-2 text-warning" aria-hidden="true"></i> @AppConstants.Texts.Layout.Contact
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    @* --- GŁÓWNY KONTENER UKŁADU --- *@
    <div class="d-flex flex-grow-1 w-100" style="min-height: 100vh;">

        @* --- SIDEBAR --- *@
        <nav class="sidebar-container d-none d-lg-flex flex-column p-3 text-white flex-shrink-0" style="width: 275px;">
            <h1 class="visually-hidden">Pasek boczny nawigacji</h1>

            <div class="mb-5 text-center">
                <img src="@Url.Content(AppConstants.Assets.LogoPath)" alt="@AppConstants.Texts.CompanyName" class="img-fluid" style="max-width: 140px; margin-bottom: 10px;">
                <p class="small text-white-50" style="font-size: 0.8rem;">@AppConstants.Texts.Slogan</p>
            </div>

            <div class="d-flex flex-column justify-content-between text-white text-center shadow-sm"
                 style="background-color: @AppConstants.Colors.Primary; min-height: 400px; border-radius: 15px; overflow: hidden;">
                <div style="height: 30px; width: 100%; background: linear-gradient(to bottom, @AppConstants.Colors.White 0%, @AppConstants.Colors.Accent 25%, @AppConstants.Colors.Accent 100%);"></div>

                <div class="d-flex flex-column align-items-center w-100 flex-grow-1 pt-4 pb-4">
                    <div class="nav nav-pills flex-column gap-3 w-75">

                        <h2 class="w-100 m-0 p-0 fs-6 fw-normal">
                            <a class="nav-link text-white text-center shadow-sm"
                               asp-controller="@AppConstants.Routing.HomeController"
                               asp-action="@AppConstants.Routing.ActionIndex"
                               asp-route-visitorId="@currentVisitorId"
                               style="background-color: @GetButtonColor(AppConstants.Routing.HomeController, AppConstants.Routing.ActionIndex);">
                                @AppConstants.Texts.Layout.Questionnaires
                            </a>
                        </h2>

                        @if (_context.Forms != null)
                        {
                            foreach (var form in _context.Forms.Where(f => f.IsActive).ToList())
                            {
                                <h2 class="w-100 m-0 p-0 fs-6 fw-normal">
                                    <a class="nav-link text-white text-center shadow-sm"
                                       asp-controller="@AppConstants.Routing.QuestionnaireController"
                                       asp-action="@AppConstants.Routing.ActionFill"
                                       asp-route-kw="@form.Id"
                                       asp-route-visitorId="@currentVisitorId"
                                       style="background-color: @GetButtonColor(AppConstants.Routing.QuestionnaireController, AppConstants.Routing.ActionFill, form.Id.ToString());">
                                        @form.Title
                                    </a>
                                </h2>
                            }
                        }

                        <h2 class="w-100 m-0 p-0 fs-6 fw-normal">
                            <a class="nav-link text-white text-center shadow-sm"
                               asp-controller="@AppConstants.Routing.HomeController"
                               asp-action="@AppConstants.Routing.ActionContact"
                               asp-route-visitorId="@currentVisitorId"
                               style="background-color: @GetButtonColor(AppConstants.Routing.HomeController, AppConstants.Routing.ActionContact);">
                                @AppConstants.Texts.Layout.Contact
                            </a>
                        </h2>

                    </div>
                </div>
                <div style="height: 30px; width: 100%; background: linear-gradient(to top, @AppConstants.Colors.White 0%, @AppConstants.Colors.Accent 25%, @AppConstants.Colors.Accent 100%);"></div>
            </div>
        </nav>

        @* --- GŁÓWNA ZAWARTOŚĆ --- *@
        <div class="d-flex flex-column flex-grow-1 w-100">

            @* HEADER *@
            <header class="bg-white p-3 border-bottom d-flex justify-content-between align-items-center">
                <h1 class="visually-hidden">Pasek górny</h1>

                <section aria-labelledby="lang-heading" class="d-flex gap-3 align-items-center ms-3">
                    <h2 id="lang-heading" class="visually-hidden">Wybór języków</h2>

                    <form asp-controller="@AppConstants.Routing.CultureController" asp-action="@AppConstants.Routing.ActionSetCulture"
                          asp-route-returnUrl="@Context.Request.Path@Context.Request.QueryString"
                          method="post" class="d-flex gap-3 align-items-center">
                        <button type="submit" name="culture" value="pl-PL" class="btn p-0 border-0 bg-transparent" title="Polski">
                            <svg xmlns="http://www.w3.org/2000/svg" width="34" height="24" viewBox="0 0 640 480" class="rounded shadow-sm flag-hover" role="img" aria-label="Polska flaga"><g fill-rule="evenodd"><path fill="#fff" d="M640 480H0V0h640z" /><path fill="#dc143c" d="M640 480H0V240h640z" /></g><rect width="640" height="480" fill="none" stroke="#e0e0e0" stroke-width="2" /></svg>
                        </button>
                        <button type="submit" name="culture" value="en-US" class="btn p-0 border-0 bg-transparent" title="English">
                            <svg xmlns="http://www.w3.org/2000/svg" width="34" height="24" viewBox="0 0 640 480" class="rounded shadow-sm flag-hover" role="img" aria-label="USA flag"><path fill="#bd3d44" d="M0 0h640v480H0" /><path stroke="#fff" stroke-width="37" d="M0 553v-553h640" /><path fill="#fff" d="M0 37l640 405m0-405L0 442" /><path stroke="#192f5d" stroke-width="24" d="M0 553v-553h640M0 37l640 405m0-405L0 442" /><rect width="640" height="480" fill="#bf0a30" /><path fill="#fff" d="M0 40h640v40H0zM0 120h640v40H0zM0 200h640v40H0zM0 280h640v40H0zM0 360h640v40H0zM0 440h640v40H0z" /><rect width="260" height="230" fill="#002868" /><text x="15" y="150" font-size="180" fill="white">★</text><rect width="640" height="480" fill="none" stroke="#e0e0e0" stroke-width="2" /></svg>
                        </button>
                    </form>
                </section>

                <div class="d-flex flex-column align-items-end">
                    <h2 class="m-0 p-0 lh-1">
                        <img src="@Url.Content(AppConstants.Assets.NamePath)" alt="@AppConstants.Texts.CompanyName" style="height: 50px; width: auto; object-fit: contain;">
                    </h2>

                    <h2 class="mt-1 d-none d-sm-block m-0 p-0" style="font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 1.875rem; line-height: 1.2; color: @AppConstants.Colors.Accent;">
                        @AppConstants.Texts.Slogan
                    </h2>
                    <h2 class="mt-1 d-block d-sm-none m-0 p-0" style="font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 1.1rem; line-height: 1.2; color: @AppConstants.Colors.Accent;">
                        @AppConstants.Texts.Slogan
                    </h2>
                </div>
            </header>

            @* WCAG: Main content z tabindex i ID dla fokusu *@
            <main id="main-content" class="flex-grow-1 bg-white" tabindex="-1" style="outline: none;">
                <h1 class="visually-hidden">Treść główna</h1>

                <div class="container-fluid pt-4 p-4 h-100">
                    <div class="row h-100">
                        <div class="col-12">
                            <div class="d-flex flex-column justify-content-between text-white shadow-sm h-100"
                                 style="background-color: @AppConstants.Colors.Primary; min-height: 600px; border-radius: 15px; overflow: hidden;">
                                <div style="height: 30px; width: 100%; background: linear-gradient(to bottom, @AppConstants.Colors.White 0%, @AppConstants.Colors.Accent 25%, @AppConstants.Colors.Accent 100%); flex-shrink: 0;"></div>
                                <div class="w-100 flex-grow-1 p-4" style="color: white; overflow: auto;">
                                    @RenderBody()
                                </div>
                                <div style="height: 30px; width: 100%; background: linear-gradient(to top, @AppConstants.Colors.White 0%, @AppConstants.Colors.Accent 25%, @AppConstants.Colors.Accent 100%); flex-shrink: 0;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <footer class="bg-white border-top text-muted mt-auto">
                <h1 class="visually-hidden">Stopka</h1>
                <div class="container-fluid p-3 text-center">
                    &copy; @DateTime.Now.Year - @AppConstants.Texts.CompanyName -
                    <a href="#" data-bs-toggle="modal" data-bs-target="#privacyModal">@AppConstants.Texts.Layout.PrivacyPolicy</a> |
                    <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">@AppConstants.Texts.Layout.Terms</a>
                </div>
            </footer>
        </div>
    </div>

    @* --- COOKIE CONSENT --- *@
    <div id="cookieConsentContainer" role="dialog" aria-labelledby="cookieHeading" class="fixed-bottom p-4 shadow-lg"
         style="background-color: @AppConstants.Colors.Primary; border-top: 4px solid @AppConstants.Colors.ButtonSubmit; display: none; z-index: 9999;">
        <div class="container">
            <div class="d-flex flex-column flex-md-row align-items-center justify-content-between gap-3">
                <div class="text-white">
                    <h5 id="cookieHeading" class="fw-bold mb-1" style="color: @AppConstants.Colors.ButtonSubmit;">@AppConstants.Texts.Layout.CookieHeader</h5>
                    <p class="mb-0 small opacity-75">
                        @AppConstants.Texts.Layout.CookieBody
                        <a href="#" data-bs-toggle="modal" data-bs-target="#privacyModal" class="text-white text-decoration-underline">@AppConstants.Texts.Layout.PrivacyPolicy</a>.
                    </p>
                </div>
                <div class="d-flex gap-2 flex-shrink-0">
                    <button id="acceptCookies" class="btn fw-bold px-4 py-2 shadow-sm"
                            style="background-color: @AppConstants.Colors.ButtonSubmit; color: #000; border-radius: 25px;">
                        @AppConstants.Texts.Layout.CookieButton
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (!localStorage.getItem("cookieConsent")) {
                setTimeout(function() {
                    var cookieContainer = document.getElementById("cookieConsentContainer");
                    cookieContainer.style.display = "block";
                }, 500);
            }
            document.getElementById("acceptCookies").addEventListener("click", function () {
                localStorage.setItem("cookieConsent", "true");
                document.getElementById("cookieConsentContainer").style.display = "none";
            });

            // SKRYPT FOKUSOWANIA: Jeśli URL ma #main-content (skip link), ustaw fokus
            if (window.location.hash === '#main-content') {
                const main = document.getElementById('main-content');
                if (main) {
                    setTimeout(() => main.focus(), 100);
                }
            }
        });
    </script>

    @* --- MODALE --- *@
    <div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title h5" id="privacyModalLabel">@AppConstants.Texts.Layout.PrivacyPolicy</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
                </div>
                <div class="modal-body text-dark" style="text-align: left;">
                    @Html.Raw(AppConstants.Texts.PolicyContent.PrivacyAndCookies)
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title h5" id="termsModalLabel">@AppConstants.Texts.Layout.Terms</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
                </div>
                <div class="modal-body text-dark" style="text-align: left;">
                    @Html.Raw(AppConstants.Texts.PolicyContent.Terms)
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                </div>
            </div>
        </div>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>