@using INeed.Helpers
@using System.Globalization
@model INeed.Models.ViewModels.FinalResultVm

@{
    ViewData[AppConstants.Keys.Title] = Model.FormTitle;
    bool showBoth = Model.IsMale == null;
}

<div class="container py-5">
    @if (TempData[AppConstants.Keys.SuccessMessage] != null)
    {
        <div class="row justify-content-center mb-4">
            <div class="col-lg-8">
                <div class="alert alert-success border-0 shadow-sm text-center" style="border-radius: 10px;" role="alert">
                    @TempData[AppConstants.Keys.SuccessMessage]
                </div>
            </div>
        </div>
    }
    @if (TempData[AppConstants.Keys.ErrorMessage] != null)
    {
        <div class="row justify-content-center mb-4">
            <div class="col-lg-8">
                <div class="alert alert-danger border-0 shadow-sm text-center" style="border-radius: 10px;" role="alert">
                    @TempData[AppConstants.Keys.ErrorMessage]
                </div>
            </div>
        </div>
    }

    <div class="row justify-content-center">
        <div class="col-lg-10 text-center">

            <main class="card shadow-lg border-0 p-4 p-md-5 mb-5" style="border-radius: 20px;">

                <h1 id="start-heading" class="fw-bold mb-4 h2" tabindex="-1" style="outline: none;">
                    @AppConstants.Texts.Result.Header: @Model.FormTitle
                </h1>

                <p class="text-muted mb-5">
                    @AppConstants.Texts.Result.SubHeader
                </p>

                @if (!Model.Categories.Any())
                {
                    <div class="alert alert-warning" role="alert">
                        @AppConstants.Texts.Messages.NoData
                    </div>
                }

                @for (int i = 0; i < Model.Categories.Count; i++)
                {
                    var cat = Model.Categories[i];
                    var descId = "cat-desc-" + i;

                    // PRZYGOTOWANIE TEKSTU DLA LEKTORA (C#)
                    string fullTextForSpeech = "";
                    if (showBoth)
                    {
                        fullTextForSpeech = $"{AppConstants.Texts.Result.NormsFemale}. STEN: {cat.StenFemale}. {cat.AdviceFemale}. " +
                        $"{AppConstants.Texts.Result.NormsMale}. STEN: {cat.StenMale}. {cat.AdviceMale}.";
                    }
                    else
                    {
                        string genderLabel = Model.IsMale == false ? AppConstants.Texts.Labels.Woman : AppConstants.Texts.Labels.Man;
                        fullTextForSpeech = $"{AppConstants.Texts.Result.YourResultSten}: {cat.StenUser} ({genderLabel}). {cat.Advice}";
                    }

                    <article class="mb-5 text-start">

                        @* --- NAGŁÓWEK KATEGORII (TAB STOP) --- *@
                        <div class="category-header-focus p-2 rounded"
                             tabindex="0"
                             role="button"
                             aria-expanded="false"
                             aria-controls="@descId"
                             aria-label="@string.Format(AppConstants.Texts.Result.CategoryAriaLabelFormat, cat.CategoryName, cat.ScoreObtained, cat.ScoreMax)">


                            <div class="d-flex justify-content-between align-items-end mb-2">
                                <h2 class="text-uppercase fw-bold m-0 h4" style="color: @AppConstants.Colors.TextDark;" aria-hidden="true">
                                    @cat.CategoryName
                                </h2>

                                <span class="fw-bold fs-5" aria-hidden="true">
                                    @cat.ScoreObtained <span class="text-muted fs-6 fw-normal">/ @cat.ScoreMax pkt</span>
                                </span>
                            </div>

                            <div class="progress mb-4" style="height: 20px; border-radius: 10px; background-color: @AppConstants.Colors.ProgressBackground;" aria-hidden="true">
                                <div class="progress-bar shadow-sm"
                                     style="width: @cat.Percent.ToString("0", CultureInfo.InvariantCulture)%; background-color: @cat.Color; border-radius: 10px;">
                                </div>
                            </div>
                        </div>

                        @* --- KONTENER OPISÓW (CEL ENTERA) --- *@
                        <div id="@descId"
                             class="description-wrapper mt-1 rounded p-2"
                             tabindex="-1"
                             role="region"
                             aria-label="@fullTextForSpeech"
                             style="outline: none;">

                            @{
                                // Definicja funkcji lokalnej dostępna dla obu bloków (if/else)
                                void RenderGenderCard(string title, string bgColor, string borderColor, string txtColor, int stenValue, string desc, string advice, string colClass = "col-md-6")
                                {
                                    <div class="@colClass">
                                        <section class="p-4 h-100 border rounded shadow-sm"
                                                 style="background-color: @bgColor; border-color: @borderColor !important;">
                                            <h3 class="fw-bold h5" style="color: @txtColor;">@title</h3>
                                            <hr style="border-color: @txtColor; opacity: 0.3;">
                                            <div class="mb-3">
                                                <strong>STEN: @stenValue</strong>
                                                <span class="badge bg-white text-dark border ms-2">@desc</span>
                                            </div>
                                            <p class="mb-0 small text-muted" style="line-height: 1.6;">@advice</p>
                                        </section>
                                    </div>
                                }
                            }

                            @if (showBoth)
                            {
                                <div class="row g-4" aria-hidden="true">
                                    @{
                                        RenderGenderCard(
                                        AppConstants.Texts.Result.NormsFemale,
                                        AppConstants.Colors.BgFemale,
                                        AppConstants.Colors.BorderFemale,
                                        AppConstants.Colors.TextFemale,
                                        cat.StenFemale,
                                        cat.DescFemale,
                                        cat.AdviceFemale
                                        );

                                        RenderGenderCard(
                                        AppConstants.Texts.Result.NormsMale,
                                        AppConstants.Colors.BgMale,
                                        AppConstants.Colors.BorderMale,
                                        AppConstants.Colors.TextMale,
                                        cat.StenMale,
                                        cat.DescMale,
                                        cat.AdviceMale
                                        );
                                    }
                                </div>
                            }
                            else
                            {
                                // Logika wyboru kolorów i tekstów dla konkretnej płci
                                bool isMale = Model.IsMale.Value;
                                var title = isMale ? AppConstants.Texts.Result.NormsMale : AppConstants.Texts.Result.NormsFemale;
                                var bg = isMale ? AppConstants.Colors.BgMale : AppConstants.Colors.BgFemale;
                                var border = isMale ? AppConstants.Colors.BorderMale : AppConstants.Colors.BorderFemale;
                                var txt = isMale ? AppConstants.Colors.TextMale : AppConstants.Colors.TextFemale;
                                var desc = isMale ? cat.DescMale : cat.DescFemale;

                                <div class="row justify-content-center" aria-hidden="true">
                                    @{
                                        RenderGenderCard(
                                        title,
                                        bg,
                                        border,
                                        txt,
                                        cat.StenUser,
                                        desc,
                                        cat.Advice,
                                        "col-md-8"
                                        );
                                    }
                                </div>
                            }
                        </div>
                    </article>
                }
            </main>

            <section class="card shadow-sm border-0 p-5 mx-auto" style="border-radius: 20px; background-color: @AppConstants.Colors.BackgroundLight; max-width: 800px;">
                <h2 class="fw-bold mb-3 h4">@AppConstants.Texts.Result.SaveHeader</h2>
                <p class="text-muted mb-4">@AppConstants.Texts.Result.SaveSubHeader</p>

                <form asp-action="SendResult" asp-controller="Questionnaire" method="post" class="d-flex flex-column align-items-center">
                    @Html.AntiForgeryToken()
                    <input type="hidden" asp-for="FormId" />
                    <input type="hidden" asp-for="FormTitle" />
                    <input type="hidden" asp-for="VisitorId" />
                    <input type="hidden" asp-for="IsMale" />
                    @for (int i = 0; i < Model.Categories.Count; i++)
                    {
                        <input type="hidden" asp-for="Categories[i].CategoryName" />
                        <input type="hidden" asp-for="Categories[i].Color" />
                        <input type="hidden" asp-for="Categories[i].ScoreObtained" />
                        <input type="hidden" asp-for="Categories[i].ScoreMax" />
                        <input type="hidden" asp-for="Categories[i].StenUser" />
                        <input type="hidden" asp-for="Categories[i].StenFemale" />
                        <input type="hidden" asp-for="Categories[i].StenMale" />
                        <input type="hidden" asp-for="Categories[i].DescFemale" />
                        <input type="hidden" asp-for="Categories[i].DescMale" />
                        <input type="hidden" asp-for="Categories[i].Advice" />
                        <input type="hidden" asp-for="Categories[i].AdviceFemale" />
                        <input type="hidden" asp-for="Categories[i].AdviceMale" />
                    }

                    <div class="mb-3 w-75">
                        <label for="resultEmail" class="visually-hidden">@AppConstants.Texts.Labels.EmailPlaceholder</label>

                        @* --- ZMIANA: Instrukcja dla czytnika --- *@
                        <span id="email-instruction" class="visually-hidden">
							@AppConstants.Texts.Result.EmailInstruction
                        </span>

                        @* Dodano aria-describedby="email-instruction" *@
                        <input type="email" id="resultEmail" name="email" class="form-control bg-white text-dark border-secondary border-opacity-25 text-center"
                               placeholder="@AppConstants.Texts.Labels.EmailPlaceholder"
                               aria-describedby="email-instruction"
                               required>
                    </div>

                    <div class="mb-4 w-75 text-start">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="rodoConsent" name="rodoConsent" value="true" required>
                            <label class="form-check-label small text-muted" for="rodoConsent">
                                @AppConstants.Texts.Result.RodoConsent
                            </label>
                        </div>
                    </div>

                    <button type="submit" class="btn w-75 fw-bold py-2"
                            style="background-color: @AppConstants.Colors.Primary; color: #fff; border-radius: 10px;">
                        @AppConstants.Texts.Buttons.SendResults
                    </button>
                </form>
            </section>

            <nav class="mt-5 d-flex gap-3 justify-content-center" aria-label="Nawigacja końcowa">
                <a asp-controller="Home" asp-action="Index"
                   asp-route-id="@Model.VisitorId"
                   class="btn btn-outline-secondary px-5 py-2" style="border-radius: 10px;">
                    @AppConstants.Texts.Buttons.BackToHome
                </a>

                <a asp-controller="Questionnaire"
                   asp-action="Fill"
                   asp-route-kw="@Model.FormId"
                   asp-route-id="@Model.VisitorId"
                   class="btn btn-primary px-5 py-2 fw-bold" style="border-radius: 10px;">
                    @AppConstants.Texts.Buttons.RetakeTest
                </a>
            </nav>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function handleCategoryEnter(event, descId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const descContainer = document.getElementById(descId);
                if (descContainer) {
                    setTimeout(() => {
                        descContainer.focus();
                    }, 150);
                }
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            const startHeading = document.getElementById('start-heading');
            if (startHeading) {
                setTimeout(() => {
                    startHeading.focus();
                }, 150);
            }
        });
    </script>
}

<style>
    .category-header-focus:focus-visible {
        outline: 3px solid @AppConstants.Colors.FocusOutline !important;
        outline-offset: 4px;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.1);
        cursor: pointer;
    }

    .description-wrapper:focus {
        outline: 2px dashed @AppConstants.Colors.TextSecondary !important;
        outline-offset: 2px;
        background-color: rgba(0,0,0,0.02);
    }
</style>